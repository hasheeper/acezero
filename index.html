<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AceZero - Game Engine</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
      -webkit-font-smoothing: antialiased;
    }

    /* ============================================
       ui-root: 全屏居中容器
       ============================================ */
    .ui-root {
      position: relative;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 50% 40%, #151515 0%, #000 100%);
      overflow: hidden;
    }

    /* ============================================
       ui-scale: 固定尺寸游戏容器 (1100x850)
       通过 JS 计算 --ui-scale 实现自适应缩放
       ============================================ */
    .ui-scale {
      width: 1100px !important;
      height: 850px !important;
      flex-shrink: 0;
      position: relative;
      z-index: 10;
      margin: 0;
      border-radius: 24px;
      overflow: hidden;
      transform-origin: center center;
      transform: scale(var(--ui-scale, 1));
      background: #0b0c10;
      box-shadow: 0 0 60px rgba(0, 0, 0, 0.8);
    }

    /* ============================================
       游戏 iframe: 填满 ui-scale 容器
       ============================================ */
    #game-frame {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
      background: transparent;
    }

    /* ============================================
       加载遮罩
       ============================================ */
    #loading-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #0b0c10;
      z-index: 100;
      transition: opacity 0.5s ease;
    }

    #loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-title {
      font-family: 'Cinzel', 'Georgia', serif;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 6px;
      color: #CFB53B;
      margin-bottom: 12px;
    }

    .loading-sub {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: #555;
      letter-spacing: 3px;
    }
  </style>
</head>
<body>

  <div class="ui-root" id="ui-root">
    <div class="ui-scale" id="ui-scale">

      <!-- 加载遮罩 -->
      <div id="loading-overlay">
        <div class="loading-title">ACEZERO</div>
        <div class="loading-sub" id="loading-status">LOADING ENGINE...</div>
      </div>

      <!-- 游戏 iframe：填满 ui-scale 容器 -->
      <iframe id="game-frame" title="AceZero Game" src="" allowfullscreen></iframe>

    </div>
  </div>

  <!-- 通用数据加载器 -->
  <script src="data-loader.js"></script>

  <script>
    (function () {
      'use strict';

      // ============================================
      // 游戏路由表 - gameId → 游戏入口路径
      // 新增游戏只需在此添加一行
      // ============================================
      const GAME_ROUTES = {
        'texas-holdem': 'texasholdem/texas-holdem/texas-holdem.html',
        'blackjack': 'blackjack/blackjack.html'
      };

      const DEFAULT_GAME = 'texas-holdem';

      // ============================================
      // UI-SCALE 自适应缩放（参考 参考/index.css 模式）
      // 固定设计尺寸 1100x850，根据窗口大小缩放
      // ============================================
      const DESIGN_W = 1100;
      const DESIGN_H = 850;
      const uiScale = document.getElementById('ui-scale');

      function recalcScale() {
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const scale = Math.min(vw / DESIGN_W, vh / DESIGN_H, 1.15);
        uiScale.style.setProperty('--ui-scale', scale.toFixed(4));
      }

      recalcScale();
      window.addEventListener('resize', recalcScale);

      // ============================================
      // 引擎核心
      // ============================================
      const frame = document.getElementById('game-frame');
      const overlay = document.getElementById('loading-overlay');
      const loadingStatus = document.getElementById('loading-status');
      let _currentConfig = null;

      let _configSource = null; // 'injected' | 'static'
      let _configSentToGame = false;

      // 1. 确定配置来源（外部注入 or 本地 JSON）
      async function resolveConfig() {
        if (_currentConfig) return _currentConfig;

        // 优先：外部注入（来自 STver.html postMessage）
        const injected = window.AceZeroDataLoader.getInjectedConfig();
        if (injected) {
          console.log('[ENGINE] 使用外部注入配置');
          _currentConfig = injected;
          _configSource = 'injected';
          return injected;
        }

        // 回退：加载本地 game-config.json
        try {
          loadingStatus.textContent = 'LOADING CONFIG...';
          const resp = await fetch('game-config.json');
          // fetch 期间注入配置可能已到达
          if (_configSource === 'injected') {
            console.log('[ENGINE] fetch 期间注入配置已到达，丢弃 game-config.json');
            return _currentConfig;
          }
          if (resp.ok) {
            const config = await resp.json();
            console.log('[ENGINE] 从 game-config.json 加载配置');
            _currentConfig = config;
            _configSource = 'static';
            return config;
          }
        } catch (e) {
          console.warn('[ENGINE] game-config.json 加载失败:', e);
        }

        // 最终回退：默认 gameId
        _currentConfig = { gameId: DEFAULT_GAME };
        _configSource = 'static';
        return _currentConfig;
      }

      // 2. 根据 gameId 路由到对应游戏
      function resolveGameUrl(gameId) {
        const route = GAME_ROUTES[gameId] || GAME_ROUTES[DEFAULT_GAME];
        const base = window.location.href.replace(/[^/]*$/, '');
        return base + route;
      }

      function resolveGameKey(config) {
        const raw = (config && (config.gameMode || config.gameId)) || DEFAULT_GAME;
        const norm = String(raw).toLowerCase();
        if (norm === '21' || norm === 'blackjack') return 'blackjack';
        if (norm === 'texas' || norm === 'texas-holdem' || norm === 'holdem') return 'texas-holdem';
        return GAME_ROUTES[norm] ? norm : DEFAULT_GAME;
      }

      // 3. 向游戏 iframe 发送配置（附带来源标记，仅首次生效）
      function sendConfigToGame(config, source) {
        if (!frame || !frame.contentWindow) return;
        if (_configSentToGame) {
          console.log('[ENGINE] 配置已发送，忽略重复');
          return;
        }
        _configSentToGame = true;
        frame.contentWindow.postMessage({
          type: 'acezero-game-data',
          payload: config,
          source: source || _configSource || 'static'
        }, '*');
      }

      // 4. 启动
      async function boot() {
        const config = await resolveConfig();
        const gameId = resolveGameKey(config);

        console.log('[ENGINE] gameId:', gameId);
        loadingStatus.textContent = 'LOADING ' + gameId.toUpperCase() + '...';

        // 设置 iframe src
        let gameSrc = resolveGameUrl(gameId);
        const sep = gameSrc.includes('?') ? '&' : '?';
        gameSrc += sep + 'v=' + Date.now();
        frame.src = gameSrc;

        // iframe 加载完成后：传递最新配置 + 隐藏 loading
        frame.addEventListener('load', function onLoad() {
          // 始终发送最新的 _currentConfig（可能在 fetch 期间被注入配置更新）
          sendConfigToGame(_currentConfig, _configSource);
          overlay.classList.add('hidden');
          frame.removeEventListener('load', onLoad);
        });
      }

      // 5. 监听游戏主动请求配置（绕过 _configSentToGame 防重复）
      window.addEventListener('message', async (event) => {
        const msg = event?.data;
        if (!msg) return;

        if (msg.type === 'acezero-data-request') {
          const config = await resolveConfig();
          if (!frame || !frame.contentWindow) return;
          frame.contentWindow.postMessage({
            type: 'acezero-game-data',
            payload: config,
            source: _configSource || 'static'
          }, '*');
        }
      });

      // 6. 处理外部注入延迟到达（STver → index → game）
      window.AceZeroDataLoader.onConfigLoaded(function (config) {
        console.log('[ENGINE] 外部配置延迟到达');
        _currentConfig = config;
        _configSource = 'injected';
        sendConfigToGame(config, 'injected');
      });

      // ============================================
      // 启动引擎
      // ============================================
      boot();

    })();
  </script>
</body>
</html>
