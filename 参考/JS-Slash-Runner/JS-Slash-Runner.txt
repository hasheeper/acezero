酒馆助手 (Tavern Helper)
简介
酒馆助手是一个为 SillyTavern 设计的多功能扩展. 它不仅能在对话中渲染交互式的前端界面, 还能实现与 SillyTavern 本身的深度交互, 以及作为中间层连接 SillyTavern 与外部应用程序. 通过这个扩展, 你可以:

🖥️ 为角色卡提供更好的 UI 显示: 如将消息楼层中原本只是代码块纯文本的状态栏美化为有动态效果、有交互的 html 状态栏
🎮 实现非纯文本的游玩体验: 如监听现实时间或酒馆事件来实现 meta 游戏、播放多媒体文件、自制游玩界面并与酒馆交互
🔧 优化酒馆使用体验: 如用 jQuery 为预设提示词条目新增复制按钮, 监听酒馆接收到消息事件并判断是否需要重新生成本楼层消息
🔌 连接外部应用程序: 如通过 socket.io-client 连接外部服务器, 进而实现外部应用程序与酒馆的通信
🎁 新增额外功能: 如每 20 楼在后台调用一次 LLM 来生成对之前剧情的总结
...
指引
根据你的需求, 可以查看以下内容:

💾 安装与更新 - 如何安装和配置酒馆助手
📖 基本用法 - 学习酒馆助手在 SillyTavern 中的基本用法
🔍 功能详情 - 作为角色卡编写者/开发者, 深入了解所有可用功能
❓ 常见问题解答 - 作为角色卡游玩者, 解决使用中遇到的问题
安全风险
酒馆助手允许执行自定义 JavaScript 代码, 这可能会带来安全风险:

恶意脚本可能会窃取你的 API 密钥、聊天记录等敏感信息; 修改或破坏你的 SillyTavern 设置
某些脚本可能会执行危险操作, 如发送未经授权的请求
请在执行任何脚本前:

仔细检查脚本内容, 确保其来源可信
理解脚本的功能和可能的影响
如有疑问, 请勿执行来源不明的脚本
我们不为第三方脚本造成的任何损失负责

参考项目
【SillyTavern / ST酒馆】html代码注入器 - 参考了使用捕捉代码块的方式来替换渲染界面的思路
Dynamic Audio - 参考了播放器布局
前端编写问题
提示
为了避免代码渲染的结果在网页界面中, 和在酒馆中呈现不一致的问题, 请务必先阅读如何正确使用酒馆助手, 使用配置好的实时编写前端模板创作界面.

代码渲染问题
问题: 编写的代码不显示界面或显示不正确
解决: 确保同时满足以下条件:

代码使用三个反引号包裹
代码中包含 <body></body> 闭合标签
QR 触发失效
问题: QR 触发不起作用?
解决: 检查并删除代码中的 triggerSlash 函数定义, 避免覆盖扩展的函数

在代码预览网站中的显示与酒馆中的显示有差异
问题: 在前端代码预览网站中显示正常的代码, 拷贝到酒馆中却样式不一致了
解决: 酒馆楼层中的前端是以<iframe>标签包裹的, 需要格外注意使用到vw和vh等相对于窗口大小的单位, 在酒馆中他们会以楼层iframe为基准, 而不是以视口为基准. 特别来说, min-height: * vh为了防止iframe高度异常，会被酒馆助手自动转换为以视口高度为基准, 其余未做处理.

渲染器
在楼层消息中显示前端界面
提示
要使用这一功能的作者请务必阅读如何正确使用酒馆助手, 里面有详细的编写说明和应用提示.

快速切换渲染器的开启和关闭
快捷按钮位于输入框左方的魔术棒图标菜单中, 你可以快速切换渲染器的开启和关闭.

渲染快速切换开关

启用代码折叠
将楼层中的代码块折叠起来, 以免占据过多空间. 当选择"前端"选项时, 将只会折叠符合渲染成界面条件的代码块.

启用 Blob URL 渲染
以 Blob URL 方式渲染前端界面, 将不会在控制台中重复显示大段代码, 方便调试. 但部分浏览器不支持 Blob URL, 当渲染异常时请关闭此选项.

创作一张前端角色卡
前端显示支持
酒馆原生的楼层渲染并不支持 <script> 等标签, 虽然能做一些简单美化, 但难以实现支持复杂交互的界面.

为此, 酒馆助手允许你以 iframe 方式渲染前端界面. 这样渲染出来的前端界面相当于一个独立网页, 支持 <script> 等标签乃至 Vue、React 等现代框架; 此外, 酒馆助手为其额外提供了 "功能详情" 中的各种功能, 如修改世界书、修改预设、设置变量、注入提示词等. 最初灵感来自阡濯的 html 代码注入器.

要使用酒馆助手的渲染而非酒馆的渲染, 你应该将前端界面 html 包裹在代码块内再放置于楼层消息中.

示例

```
<html>
  <head>
    <style>
            body {
              font-family: Arial, sans-serif;
              background-color: #f0f0f0;
              margin: 0;
              padding: 20px;
              text-align: center;
            }
    </style>
  </head>
  <body>
    <h1>欢迎使用脚本注入功能！</h1>
    <button onclick="showMessage()">点击我</button>
    <script>
      function showMessage() {
        alert('你点击了按钮！');
      }
    </script>
  </body>
</html>
```
注意
被扩展识别并渲染需要同时满足以下条件:
代码放置在代码块 ``` 标识中
代码中同时存在 <body> 和 </body> 标签
为防止高度无限增长, 代码中的 min-height: * vh 会被自动转换为以浏览器高度为基准, 而不是以 iframe 高度为基准
获取角色头像
使用 CSS 类
若要在界面中展示当前角色卡或用户的头像, 需使用 css 类 user-avatar ( 或user_avatar), char-avatar (或 char_avatar).

示例
在你想要放入头像的地方设置 class 为 user-avatar (或 user_avatar), char-avatar (或 char_avatar), 此时 容器的背景图片就会变为当前用户或角色的头像.


<div class="char_avatar"></div>
<div class="user_avatar"></div>
<!-- 或者<div class="char-avatar"></div> -->
<!-- 或者<div class="user-avatar"></div> -->

添加这个 css 类只会导入图片链接 background-image: url('角色卡头像链接');, 具体的图片填充方式等需使用者手动添加样式.

使用宏
头像链接已注册为宏 {{userAvatarPath}} 和 {{charAvatarPath}}, 可直接用在酒馆中. 酒 馆会将它们替换为当前 user 和 char 的图像路径.

示例

<div class="char_avatar" style="background-image: url('{{charAvatarPath}}');"></div>
<div class="user_avatar" style="background-image: url('{{userAvatarPath}}');"></div>

提示
在聊天中途更换了 user 角色, 其显示逻辑与酒馆一致, 会在新的楼层显示新的头像.
想要将旧的楼层头像显示同步, 需要点击用户面板的同步按钮.
脚本库
提示
要使用这一功能的作者请务必先阅读如何正确使用酒馆助手, 里面有详细的编写说明和应用提示.

酒馆助手的脚本库允许你在后台运行 JavaScript 脚本, 你因而可以做到每 20 楼自动调用一次 AI 来生成对之前剧情的总结等各种功能 , 且可以让这些功能与预设、角色卡等绑定.

和渲染器一样, 酒馆助手脚本也能使用 "功能详情" 中的各种功能, 如修改世界书、修改预设、设置变 量、注入提示词等.

脚本库示例

绑定机制
脚本库分为全局、预设和角色脚本库:

全局脚本库: 适用于酒馆所有聊天
预设脚本库: 适用于当前预设, 会随预设一同导出
角色脚本库: 适用于当前角色卡, 会随角色卡一同导出
如何在脚本关闭时执行函数
使用下面的方法从而在脚本关闭时执行函数:


$(window).on('pagehide', () => {
  // 在这里编写脚本关闭时的逻辑
});
注意
如果想要在酒馆页面加载完时执行函数, 不要使用 DOMContentLoaded, 而是使用 $(() => { /* 在这里编写函数 */ }), 因为 DOMContentLoaded 发出时酒馆页面可能还没有加载完.

脚本按钮
你可以为脚本添加按钮, 则用户点击按钮时会触发脚本内指定功能.

脚本按钮

绑定方法
按键绑定功能需要配合 getButtonEvent 使用, 在脚本中添加以下代码:


eventOn(getButtonEvent('按钮名称'), () => {
  // 在这里编写按键触发后的具体逻辑
  console.log('按键被点击');
});
'按钮名称'
需要与设置的按键名称一致. :::
将酒馆快速回复迁移成酒馆助手脚本
脚本按钮让酒馆助手脚本成为了酒馆快速回复的完全上位替代:

相比起写快速回复, AI 对于酒馆助手脚本的知识库更全面, 且我们专门提供 了如何正确使用酒馆助手让 AI 了解如何使用酒馆助手.
酒馆助手脚本其实对标的是酒馆插件, 在编写体验上甚至比酒馆插件更好; 而无论酒馆助手脚本还是酒馆插件, 它们所能做的大多数事 情是快速回复做不到的.
大多数快速回复都能直接写成酒馆助手脚本, 例如快速回复 /send 推进剧情 | /trigger 可以写成:


eventOn(getButtonEvent('推进'), () => {
  triggerSlash('/send 推进剧情 | /trigger');
});
提示词查看器
提示词查看器允许你了解 AI 实际会收到什么提示词——就像你在酒馆后台看到的那样——便于预设与角色卡创作等的调试. 最初灵感来自酒馆官方扩展 Prompt Inspector.

提示词查看器

界面易用性
你可以将提示词查看器窗口拖动到最左边或最右边, 从而让窗口吸附在酒馆界面边缘.
你通过拖动窗口边缘来修改窗口大小.
快捷入口
你可以在酒馆输入框左侧魔棒图标内找到它的快捷入口.

提示词查看器快捷入口

始终显示最新提示词
打开提示词查看器时
在打开提示词查看器时, 查看器将会发送一条虚假的生成请求, 相当于你在此时点击了输入框发送按钮 . 然后, 查看器将会等待酒馆处理完毕, 拦截下这段提示词 (不真的发给 AI), 从而获得最 新提示词发送情况.

点击刷新按钮 时
每次点击刷新按钮时, 查看器也会像被打开时那样发送一条虚假的生成请求.

实际发生生成请求时
无论你是:

直接点击输入框发送按钮 
使用酒馆助手 generate、generateRaw 函数
其他任何以酒馆方式发送提示词
查看器都会监听到生成请求, 获得它的提示词发送情况.

显示真正的提示词情况
相比于在预设面板所查看到的提示词还没经过酒馆某些处理, 提示词查看器所显示出的提示词已经经过了酒馆几乎所有处理:

世界书绿灯条目的激活
预设的 "压缩系统消息" 功能
提示词模板
酒馆、酒馆助手宏
其他修改提示词发送的脚本、插件
...
注意
提示词查看器所显示出的提示词唯一没经过的处理是 "提示词后处理", 因为酒馆将其放在了难以拦截的后端, 且该处理对提示词的变化过大反而不利于查看.

支持搜索
普通搜索
提示词查看器-普通搜索

正则表达式
提示词查看器-正则表达式搜索

仅显示匹配部分
提示词查看器-仅显示匹配

支持筛选
提示词查看器-筛选
变量管理器
变量管理器允许用户查看、编辑并实时监听不同作用域下的变量. 这对于调试脚本、理解功能运行状态以及动态调整参数都非常有帮助.

界面易用性
我们翻译并调整了 svelte-jsoneditor 作为变量编辑器, 它用起来非常方便.
你可以将变量管理器窗口拖动到最左边或最右边, 从而让窗口吸附在酒馆界面边缘.
你通过拖动窗口边缘来修改窗口大小.
快捷入口
你可以在酒馆输入框左侧魔棒图标内找到它的快捷入口.

变量管理器快捷入口

注册变量结构
你可以通过 registerMvuSchema 函数来注册变量结构, 从而让变量管理器能验证变量是否符合要求.

注册变量结构

日志查看器
为了便于手机玩家向作者汇报前端界面或脚本的错误, 酒馆助手会收集前端界面或脚本中由 console.info、console.warn、console.error 等记录下的日志:

日志查看器

对于作者, 除了 console.xxx 外, 也推荐使用 errorCatched.
音频播放器
既然有了甚至能制作 Galgame、杀戮尖塔等的前端界面, 你很可能需要播放音乐和音效.

但如果直接在前端界面里直接播放音频, 则可能出现 "多楼层音乐会同时播放"、"同一音频在楼层更新时无法接续播放" 等问题.

为解决这些问题, 酒馆助手制作了音频播放器.

音频播放器

作为玩家, 你可以通过设置界面
调整音量
播放模式 (单曲循环、列表循环、随机播放、播完停止)
自行导入音频到播放列表 (播放列表会绑定到聊天文件上, 因此重启酒馆将不必再次导入)
...
作为作者, 你可以通过播放音频里的函数调用音频播放器.

酒馆体验优化
自动启用/禁用了一些游玩社区预设、角色卡必然需要设置的选项
角色卡面板-更多...-替换/更新角色卡按钮将会自动导入最新世界书 (原生酒馆只会更新角色卡, 不会更新世界书)
角色卡面板-导出角色卡时必然会导出最新世界书 (原生酒馆可能导出陈旧世界书)
要加载 # 条消息将会实时去除旧楼层的显示, 从而让游玩酒馆更流畅: 如果设置要加载 # 条消息为 5, 则页面将最多显示 5 个楼层, 当发送新消息或收到新回复时, 旧楼层将会被自动取消渲染
要加载 # 条消息可以设置为任意非负数: 原本酒馆只允许要加载 # 条消息设置为 5 的倍数, 现在你可以设置为任意非负数, 如设置为 1 来只显示聊天中最近的 1 楼消息, 从而让游玩酒馆更流畅.
变量类型
提示
请务必先阅读如何正确使用酒馆助手

点击查看对应类型定义文件 (可发给 AI 或 IDE 使用, 酒馆助手界面中提供了打包下载)

酒馆仅提供了全局、聊天、扩展三类变量, 而酒馆助手对其进行扩展, 提供了更多变量类型.

在获取变量或替换或修改变量时, 你需要在 VariableOption 中指定要操作的变量类型.


VariableOption (概览)

使用示例

type VariableOption = {
  type: 'global' | 'preset' | 'character' | 'chat' | 'message' | 'script' | 'extension';
  /**
   * 根据类型不同可能有其他参数
   * 例如, 消息楼层变量还会有 `message_id: number` 允许你指定楼层号 */
   */
};

全局变量 (global)

VariableOption (type='global')

type VariableOption = {
  type: 'global';
};
绑定在用户存档上, 因而全局可用.

除了使用函数外, 你还可以在楼层文本或提示词中用 {{get_global_variable::变量}} 获取全局变量在 变量 路径下的值.

预设变量 (preset)

VariableOption (type='preset')

type VariableOption = {
  type: 'preset';
};
绑定在某个预设上, 可以随预设导出.

除了使用函数外, 你还可以在楼层文本或提示词中用 {{get_preset_variable::变量}} 获取当前预设在 变量 路径下的值.

角色卡变量 (character)

VariableOption (type='character')

type VariableOption = {
  type: 'character';
};
绑定在某个角色卡上, 可以随角色卡导出.

除了使用函数外, 你还可以在楼层文本或提示词中用 {{get_character_variable::变量}} 获取当前角色卡在 变量 路径下的值.

如果没有打开角色卡, 将会抛出错误.

聊天变量 (chat)

VariableOption (type='chat')

type VariableOption = {
  type: 'chat';
};
绑定在某个聊天文件上, 可以随聊天文件导出.

除了使用函数外, 你还可以在楼层文本或提示词中用 {{get_chat_variable::变量}} 获取当前聊天文件在 变量 路径下的值.

消息楼层变量 (message)

VariableOption (type='message')

type VariableOption = {
  type: 'message';
  /** 指定要获取变量的消息楼层号, 如果为负数则为深度索引, 例如 `-1` 表示获取最新的消息楼层; 默认为 `'latest'` */
  message_id: number | 'latest';
};
绑定在聊天文件的某个消息楼层上, 可以随聊天文件导出.

除了这里的变量函数, 你还可以用消息楼层函数批量修改聊天楼层变量.

除了使用函数外, 你还可以在楼层文本或提示词中用 {{get_message_variable::变量}} 或 {{format_message_variable::变量}} 获取最新楼层在 变量 路径下的值.
随着消息楼层增加或删除, 最新楼层会不断变化, 因而 {{get_message_variable::变量}} 或 {{format_message_variable::变量}} 也会不断变化, 始终反映最新的楼层变量值.

如果提供的消息楼层号 message_id 超出了范围 [-chat.length, chat.length), 将会抛出错误.

脚本变量 (script)

VariableOption (type='script')

type VariableOption = {
  type: 'script';
  /** 指定要获取变量的脚本 ID; 如果在脚本内调用, 则无须指定, 当然你也可以用 `getScriptId()` 获取该脚本 ID */
  script_id: string;
};
绑定在某个脚本上, 可以随脚本导出.

除了使用函数外, 你还可以在 "酒馆助手-脚本库" 中编辑脚本, 在弹出的编辑界面中手动修改脚本变量.

扩展变量 (extension)

VariableOption (type='extension')

type VariableOption = {
  type: 'extension';
  /** 指定要获取变量的扩展 ID */
  extension_id: string;
};
扩展变量其实也绑定在用户存档上, 但不同酒馆扩展一般将变量放在自己的扩展 ID 下, 彼此不干扰.

