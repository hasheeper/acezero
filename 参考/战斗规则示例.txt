<battle_rules>
[PKM 引擎协议]
PKM引擎协议是一个宝可梦对战的场景模拟器，用在实际发生战斗场景前进行演绎和播放，同时，必须在正文铺垫结束后使用此协议
触发条件：仅当「战斗逻辑判定 (Battle_Logic_Active) = YES」时，生成纯 JSON 数据并包裹在 <PKM_BATTLE> XML标签中。禁输出无关文本。
核心原则：
1. 标识符：**严格**使用官方英文 ID (Species/Moves)。例如: "Ursaluna-Bloodmoon"。
2. 难度 (difficulty): easy / normal / hard / expert。
3. 动态配置：由 entrants 配置决定具体对战形式。

[根结构]
// lines 在此处与 entrants 平级
<PKM_BATTLE>
{
  "difficulty": "expert",
  "p1": { 
    "entrants": [ {ENTITY}, ... ],
    // 可能更多
  }, 
  "p2": { 
    "entrants": [ {ENTITY}, ... ],
     // 可能更多
    "lines": { 
       "start": "start P2 dialog", 
       "win": "Text when P1 wins", 
       "lose": "Text when P1 lose", 
       "escape": "Text/Feedback when P1 running away"
    }
  },
  "environment": {ENVIRONMENT}  // (可选) 自定义战场环境
}
</PKM_BATTLE>
[模块：实体 (ENTITY) 数据结构]
必须根据数据来源，选择下方**模式 A** 或 **模式 B** 中的一种，严格遵守键值类型：

// 模式 A：库数据引用 (Library Filter)
// 适用：玩家队伍(变量)、本地数据库库内 NPC。
// 核心：仅提供 ID 引用，具体数值由系统预设决定。
{
  "name": "Unique_DB_Key",  // e.g., "{{user}}", "Cynthia"
  "type": "trainer",        // 玩家 ({{user}}) 时可省略
  "tier": 1~4,              // 仅 NPC 有效 (Int)
  "party": ["SpeciesID_A", "SpeciesID_B", …………] // (可选) String数组。筛选指定成员；若省略则全队加载。
}

// 模式 B：现场实例化 (Constructor)
// 适用：野生生物、临时敌人、需要定制数值的 Boss。
// 核心：party 必须是 Object 数组，现场定义所有数值。
{
  "name": "Display_Label_Name", // 用于显示的名称
  "type": "wild" | "trainer",
  "party": [
    // --- 结构 1: 简易构建 (适用于杂兵/普通野怪) ---
    // 必须包含 name, lv, moves 以防止崩溃
    { 
      "name": "SpeciesID", 
      "lv": <Int>, 
      "moves": ["MoveID_1", "MoveID_2", …………]
    },
    
    // --- 结构 2: 完整构建 (适用于 Boss/队长) ---
    { 
      "name": "SpeciesID", 
      "lv": <Int>, 
      // 基础属性
      "shiny": <Bool>,
      "gender": "M" | "F" | "N",
      "quality": "low" | "medium" | "high" | "perfect", // 决定个体值精度
      "nature": "NatureID", // Official English
      "ability": "AbilityID", 
      "item": "ItemID",
      // 战斗机制 (只要设定 mechanic，必填相关字段，但默认情况下不要用，可不选)
      "mechanic": "mega" | "dynamax" | "zmove" | "tera", |
      "teraType": "TypeID",  // tera后填入，要不然不用填
      // 招式与标记
      "moves": ["Move1", "Move2", "Move3", "Move4"], 
    }
  ]
}


[模块：Environment Overlay]
// 可选模块，用于创建特殊战场环境，影响战斗机制
// 适用：Boss 战、剧情战斗、区域特色地形、试炼等需要独特规则的场景

Structure:
{
  "weather": "sun"|"rain"|"sandstorm"|"snow"|"harshsun"|"heavyrain"|"deltastream"|"smog"|"ashfall"|"gale"|"fog"|"clear"|null,
  "weatherTurns": Int,
  "overlay": {
    "env_name": String,
    "narrative": String,
    "rules": [ { "target": SelectorString, "eff": [ EffectString, ... ] } ]
  }
}

Selector Syntax:
逻辑: "+"表AND，独立规则表OR，"NOT:"表取反
原子Keys:
1. Object: ALL, Side:Player|Enemy
2. State: Grounded, Flying, HasItem:Id, HasAbility:Id, Status:Id
3. Prop: Type:Id, MoveType:Id
4. Flag: Flag:Contact|Sound|Slicing|Pulse|Bullet|Wind (Check moves-data.js)

Effect Syntax (Case-insensitive):
1. Multipliers (Val 0.1~10): Atk:Val, Def:Val, SpA:Val, SpD:Val, Spe:Val, Dmg:Val, Accuracy:Val, Crit:Val, Heal:Val, Drain:Val
2. HP Mods (Ratio -0.5~0.5): HP:Val (per_turn), HP:Val:once (on_entry)
3. Type Interface: Immune:Type, Weak:Type, Ban:Type, Grant:Type, GrantType:Type, ToType:Src>Dest
4. Bans: BanItem:Id|Category, BanMove:Id
5. Status Logic: Status:Id[:Prob], ImmuneStatus:Id, Prevent:Id, Cure:Id[:Prob], Cure:all
6. Stages: CritStage:+Int, Evasion:+Int, Priority:+Int
7. Special: Recoil:Prob[:Dmg_Ratio], Immune:Ground

Example:
{
  "env_name": "Magma Cavern",
  "narrative": "Heat rises...",
  "rules": [
    { "target": "Grounded", "eff": ["HP:-0.0625"] },
    { "target": "Grounded+Type:Steel", "eff": ["Spe:0.5"] },
    { "target": "Type:Fire+HasAbility:FlashFire", "eff": ["Dmg:1.5"] },
    { "target": "MoveType:Water", "eff": ["Dmg:0.5", "Recoil:0.5"] }
  ]
}

// 将 JSON 直接写入 environment.overlay.rules。

示例（2v2）：
<PKM_BATTLE>
{
  "difficulty": "expert",
  "p1": {
    "entrants": [
      {   
        "name": "{{user}}" // 默认全上
      },
      {       // 如果有第二个人
        "name": "Marnie",
        "type": "trainer",
        "tier": 4,
        "party": ["Grimmsnarl", "Morpeko"]
      }
    ]
  },
  "p2": {
    "entrants": [
      // 实体1: 无主 Boss (全详情)
      {
        "name": "Guardian Protocol",
        "type": "wild",
        "party": [
          {
            "name": "Iron Valiant",
            "lv": 98,
            "quality": "perfect",
            "ability": "Quark Drive",
            "item": "Booster Energy",
            "moves": ["Moonblast", "Close Combat", "Spirit Break", "Thunderbolt"]
          }
        ]
      },
      // 实体2  (快速构建 x3)
      {
        "name": "Defense Drones",
        "type": "wild",
        "party": [
           // 快速1: 纯极简干扰手
           { "name": "Iron Moth", "lv": 90, "moves": ["Acid Spray", "Fiery Dance"] },
           // 快速2: 带道具速攻手
           { "name": "Iron Bundle", "lv": 90, "item": "Focus Sash", "moves": ["Icy Wind", "Flip Turn"] },
           // 快速3: 功能性肉盾
           { "name": "Iron Treads", "lv": 90, "moves": ["Stealth Rock", "Rapid Spin"] }
        ]
      }
    ]
  }
}
</PKM_BATTLE>
示例（1v1）：
<PKM_BATTLE>
{
  "difficulty": "normal",
  "p1": {
    "entrants": [
      {
        "name": "{{user}}" // 模式 A 简写，读取玩家存档全队
      }
    ]
  },
  "p2": {
    "entrants": [
      {
        "name": "Roxie", // 调用预设 NPC 数据
        "type": "trainer",
        "tier": 2, // 对应规则中的 normal 难度
        "party": ["Whirlipede", "Garbodor"] // 仅筛选这两只作为出战宝可梦，如果不写全队出战
      }
    ],
    "lines": {
      "start": "Techinical check! One, two! Get ready to be rocked by my Poison types!",
      "win": "Looks like you couldn't handle the toxicity!",
      "lose": "You... you unplugged my amp...!",
      "escape": "Hey! The show isn't over yet!"
    }
  }
}
</PKM_BATTLE>

示例（带环境的 Boss 战）：
<PKM_BATTLE>
{
  "difficulty": "expert",
  "p1": {
    "entrants": [
      { "name": "{{user}}" }
    ]
  },
  "p2": {
    "entrants": [
      {
        "name": "Void Guardian",
        "type": "wild",
        "party": [
          {
            "name": "Giratina-Origin",
            "lv": 95,
            "quality": "perfect",
            "ability": "Levitate",
            "item": "Griseous Orb",
            "moves": ["Shadow Force", "Dragon Pulse", "Aura Sphere", "Will-O-Wisp"]
          }
        ]
      }
    ],
    "lines": {
      "start": "时空的裂隙撕开了...反转世界的守护者现身！",
      "win": "裂隙...正在愈合...",
      "lose": "这个世界...将被吞噬..."
    }
  },
  "environment": {
    "weather": null,   // 不指定
    "weatherTurns": 0,
    "overlay": {
      "env_name": "反转世界",
      "narrative": "重力法则被扭曲，时空在此处交错...",
      "rules": [
        { "target": "ALL", "eff": ["Spe:0.7"] },
        { "target": "Type:Ghost", "eff": ["SpA:1.4", "Def:1.2"] },
        { "target": "Type:Dragon", "eff": ["Dmg:0.8"] }
      ]
    }
  }
}
</PKM_BATTLE>
</battle_rules>
