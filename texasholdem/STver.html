<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AceZero - Frame Wrapper</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: transparent;
    }
    #app-frame {
      width: 100%;
      height: 100vh;
      height: 100dvh;
      border: 0;
      display: block;
      background: transparent;
    }

    #frame-toolbar {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 2147483647;
      display: flex;
      gap: 8px;
      pointer-events: auto;
    }

    .tool-btn {
      appearance: none;
      border: 1px solid rgba(0, 0, 0, 0.18);
      background: rgba(255, 255, 255, 0.92);
      color: #2B2B2B;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 700;
      line-height: 1;
      cursor: pointer;
      user-select: none;
      backdrop-filter: blur(6px);
    }

    .tool-btn:active {
      transform: translateY(1px);
    }

    .tool-btn[hidden] {
      display: none;
    }

    html.pseudo-fullscreen,
    html.pseudo-fullscreen body {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      height: 100dvh;
      background: #000;
    }

    html.pseudo-fullscreen #app-frame {
      width: 100vw;
      height: 100vh;
      height: 100dvh;
    }
  </style>
</head>
<body>
  <div id="frame-toolbar">
    <button id="btn-enter" class="tool-btn" type="button">放大</button>
    <button id="btn-exit" class="tool-btn" type="button" hidden>退出</button>
  </div>
  <script id="acezero-json" type="application/json">$1</script>

  <iframe
    id="app-frame"
    title="AceZero Game"
    src=""
    sandbox="allow-scripts allow-forms allow-modals allow-popups allow-same-origin"
    allow="fullscreen"
    allowfullscreen
    referrerpolicy="no-referrer"
  ></iframe>

  <script>
    (function () {
      const root = document.documentElement;
      const btnEnter = document.getElementById('btn-enter');
      const btnExit = document.getElementById('btn-exit');
      const frame = document.getElementById('app-frame');
      const hostFrame = window.frameElement;

      // ============================================
      // 游戏路由表 - 根据 gameId 决定加载哪个游戏
      // ============================================
      const GAME_ROUTES = {
        'texas-holdem': 'texas-holdem/texas-holdem.html',
        'blackjack': 'blackjack/blackjack.html'
        // 未来新增游戏在此添加
      };

      const DEFAULT_GAME = 'texas-holdem';

      // ============================================
      // 解析注入的 JSON 数据
      // ============================================
      function parseInjectedData() {
        try {
          const dataNode = document.getElementById('acezero-json');
          if (!dataNode) return null;
          const raw = (dataNode.textContent || dataNode.innerText || '').trim();
          if (!raw || raw === '$1') return null;
          return JSON.parse(raw);
        } catch (e) {
          console.warn('[AceZero] 解析注入数据失败:', e);
          return null;
        }
      }

      // ============================================
      // 根据 gameId 设置 iframe src
      // ============================================
      function resolveGameUrl(gameId) {
        const route = GAME_ROUTES[gameId] || GAME_ROUTES[DEFAULT_GAME];
        // 获取当前页面的基础路径
        const base = window.location.href.replace(/[^/]*$/, '');
        return base + route;
      }

      // ============================================
      // 初始化：解析数据 → 路由游戏 → 设置 iframe
      // ============================================
      const injectedData = parseInjectedData();
      const gameId = (injectedData && injectedData.gameId) || DEFAULT_GAME;

      console.log('[AceZero] gameId:', gameId);
      console.log('[AceZero] injectedData:', injectedData);

      // 设置 iframe src
      let gameSrc = resolveGameUrl(gameId);
      const sep = gameSrc.includes('?') ? '&' : '?';
      gameSrc += sep + 'v=' + Date.now();
      frame.src = gameSrc;

      // ============================================
      // 调整宿主 iframe 尺寸（被 ST 嵌入时）
      // ============================================
      function resizeHostFrame() {
        if (!hostFrame) return;
        const width = Math.min(window.innerWidth || 9999, 1280);
        const height = Math.min(window.innerHeight || screen.height || 900, 860);
        hostFrame.style.width = width + 'px';
        hostFrame.style.maxWidth = '100%';
        hostFrame.style.height = height + 'px';
        hostFrame.style.minHeight = '540px';
        hostFrame.style.border = 'none';
      }
      resizeHostFrame();
      window.addEventListener('resize', resizeHostFrame);

      // ============================================
      // 全屏控制
      // ============================================
      function isFullscreen() {
        return !!document.fullscreenElement;
      }

      function isPseudo() {
        return root.classList.contains('pseudo-fullscreen');
      }

      function syncButtons() {
        const active = isFullscreen() || isPseudo();
        btnEnter.hidden = active;
        btnExit.hidden = !active;
      }

      async function enterFullscreen() {
        try {
          if (root.requestFullscreen) {
            await root.requestFullscreen();
            return;
          }
        } catch (e) {}
        root.classList.add('pseudo-fullscreen');
      }

      async function exitFullscreen() {
        try {
          if (isFullscreen() && document.exitFullscreen) {
            await document.exitFullscreen();
          }
        } catch (e) {}
        root.classList.remove('pseudo-fullscreen');
      }

      // ============================================
      // postMessage 数据传递
      // ============================================
      function postGameData() {
        if (!frame || !frame.contentWindow) return;
        if (!injectedData) return;
        frame.contentWindow.postMessage(
          {
            type: 'acezero-game-data',
            payload: injectedData,
          },
          '*'
        );
      }

      // iframe 加载完成后发送数据
      frame.addEventListener('load', postGameData);

      // 游戏主动请求数据时响应
      window.addEventListener('message', (event) => {
        const payload = event?.data;
        if (!payload || payload.type !== 'acezero-data-request') return;
        if (!injectedData || !frame || !frame.contentWindow) return;
        frame.contentWindow.postMessage(
          {
            type: 'acezero-game-data',
            payload: injectedData,
          },
          '*'
        );
      });

      // ============================================
      // 按钮事件
      // ============================================
      btnEnter.addEventListener('click', () => {
        enterFullscreen().finally(syncButtons);
      });
      btnExit.addEventListener('click', () => {
        exitFullscreen().finally(syncButtons);
      });

      document.addEventListener('fullscreenchange', syncButtons);
      syncButtons();
    })();
  </script>
</body>
</html>
